name: '01 - Infrastructure (Terraform)'

run-name: "ğŸ—ï¸ Infra: ${{ github.ref_name }} | @${{ github.actor }}"

on:
  workflow_dispatch:
  push:
    paths:
      - 'infra/**'
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  # JOB 1: Preview the changes (Automatic)
  terraform_plan:
    name: "ğŸ” Terraform: Plan"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infra
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_USE_OIDC: true

    steps:
      - name: "ğŸ“‚ Checkout Code"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: "ğŸ“¥ Initialize"
        run: terraform init -backend-config="storage_account_name=${{ secrets.STORAGE_ACCOUNT_NAME }}"

      - name: "ğŸ” Run Plan"
        run: terraform plan -input=false

  # JOB 2: Apply the changes (Requires Approval)
  terraform_deploy:
    name: "ğŸš€ Terraform: Deploy"
    needs: terraform_plan # Only runs if Plan succeeds
    runs-on: ubuntu-latest
    environment: production # This triggers the manual approval button
    
    defaults:
      run:
        working-directory: ./infra

    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_USE_OIDC: true

    steps:
      - name: "ğŸ“‚ Checkout Code"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: "ğŸ“¥ Initialize"
        run: terraform init -backend-config="storage_account_name=${{ secrets.STORAGE_ACCOUNT_NAME }}"

      - name: "ğŸš€ Execute Apply"
        run: terraform apply -auto-approve -input=false